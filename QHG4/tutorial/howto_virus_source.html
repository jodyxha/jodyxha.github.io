<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The Source File for the Action Class Virus &#8212; QHG4 4.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../static/jody.css?v=dac31e62" />
    
    <script src="../static/documentation_options.js?v=3b2dd2c4"></script>
    <script src="../static/doctools.js?v=888ff710"></script>
    <script src="../static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="https://github.com/jodyxha/jodyxha.github.io/tree/main/QHG4/images/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Header File for the Population Class VirusHostPop" href="howto_virushost_header.html" />
    <link rel="prev" title="The Header File for the Action Class Virus" href="howto_virus_header.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="howto_virushost_header.html" title="The Header File for the Population Class VirusHostPop"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="howto_virus_header.html" title="The Header File for the Action Class Virus"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">QHG4 4.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../tutorial.html" >QHG Tutorial</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="how_to_build_actions_pops.html" accesskey="U">How to Design and Build New Populations and Actions</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">The Source File for the Action Class <code class="docutils literal notranslate"><span class="pre">Virus</span></code></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="the-source-file-for-the-action-class-virus">
<span id="howto-virus-source-ref"></span><h1>The Source File for the Action Class <code class="docutils literal notranslate"><span class="pre">Virus</span></code><a class="headerlink" href="#the-source-file-for-the-action-class-virus" title="Link to this heading">¶</a></h1>
<p>At the beginning of <code class="docutils literal notranslate"><span class="pre">Virus.cpp</span></code> we must put the header files we need:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;omp.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;MessLoggerT.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;clsutils.cpp&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ParamProvider2.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SPopulation.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SCell.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;WELL512.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;QDFUtils.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;QDFUtilsT.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Virus.h&quot;</span>
</pre></div>
</div>
<p>We also need to define attribute names to read and write the action’s attributes.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">asNames</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ATTR_VIRUS_INFECTION_PROB_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="n">ATTR_VIRUS_INITIAL_LOAD_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="n">ATTR_VIRUS_GROWTH_RATE_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="n">ATTR_VIRUS_CONTAGION_LEVEL_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="n">ATTR_VIRUS_LETHALITY_LEVEL_NAME</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<section id="constructor">
<h2><code class="docutils literal notranslate"><span class="pre">constructor</span></code><a class="headerlink" href="#constructor" title="Link to this heading">¶</a></h2>
<p>There is not much to do in the constructor: intialisation of the variables,
and saving the attribute names.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Virus</span><span class="p">(</span><span class="n">SPopulation</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="o">*</span><span class="n">pPop</span><span class="p">,</span><span class="w"> </span><span class="n">SCellGrid</span><span class="w"> </span><span class="o">*</span><span class="n">pCG</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">sID</span><span class="p">,</span><span class="w"> </span><span class="n">WELL512</span><span class="w"> </span><span class="o">**</span><span class="n">apWELL</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Action</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pPop</span><span class="p">,</span><span class="n">pCG</span><span class="p">,</span><span class="n">ATTR_VIRUS_NAME</span><span class="p">,</span><span class="n">sID</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_apWELL</span><span class="p">(</span><span class="n">apWELL</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_fInfectionProb</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_fInitialLoad</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_fGrowthRate</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_fContagionLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_fLethalityLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">m_iNumThreads</span><span class="p">(</span><span class="n">omp_get_max_threads</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_vNames</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_vNames</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">asNames</span><span class="p">,</span><span class="w"> </span><span class="n">asNames</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">asNames</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// create array with one int map for each thread</span>
<span class="w">    </span><span class="n">m_amCellAgents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">cellagentmap</span><span class="p">[</span><span class="n">m_iNumThreads</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// create array with one map for each thread</span>
<span class="w">    </span><span class="n">m_amAgentInfects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w">  </span><span class="n">agentloadmap</span><span class="p">[</span><span class="n">m_iNumThreads</span><span class="p">];</span>

<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="destructor">
<h2><code class="docutils literal notranslate"><span class="pre">destructor</span></code><a class="headerlink" href="#destructor" title="Link to this heading">¶</a></h2>
<p>The destructor deletes the arrays that were allocated in the constructor</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::~</span><span class="n">Virus</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// delete the arrays</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">m_amCellAgents</span><span class="p">;</span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">m_amAgentInfects</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="initialize">
<h2><code class="docutils literal notranslate"><span class="pre">initialize</span></code><a class="headerlink" href="#initialize" title="Link to this heading">¶</a></h2>
<p>The method initialize is called before <code class="docutils literal notranslate"><span class="pre">execute()</span></code>.
Here the array of maps relating cell indexes to agent indexes (<code class="docutils literal notranslate"><span class="pre">m_amCellAGents</span></code>) is filled,
and the array of maps relating agent IDs to virus loads (<code class="docutils literal notranslate"><span class="pre">m_amAgentInfects</span></code>) is resaet.</p>
<p>Note that since <code class="docutils literal notranslate"><span class="pre">initialize</span></code> is not called in a parllelized context,
we can use parallelized loops with the full set of available threads.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">initialize</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">fT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// clear the agent arrays and the infection registerr</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iT</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_iNumThreads</span><span class="p">;</span><span class="w"> </span><span class="n">iT</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">m_amCellAgents</span><span class="p">[</span><span class="n">iT</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
<span class="w">        </span><span class="n">m_amAgentInfects</span><span class="p">[</span><span class="n">iT</span><span class="p">].</span><span class="n">clear</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iFirstAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">getFirstAgentIndex</span><span class="p">();</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iLastAgent</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">getLastAgentIndex</span><span class="p">();</span>

<span class="cp">#pragma omp parallel for</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iFirstAgent</span><span class="p">;</span><span class="w"> </span><span class="n">iA</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">iLastAgent</span><span class="p">;</span><span class="w"> </span><span class="n">iA</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">();</span>
<span class="w">        </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">pA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iA</span><span class="p">]);</span>
<span class="w">        </span><span class="n">m_amCellAgents</span><span class="p">[</span><span class="n">iT</span><span class="p">][</span><span class="n">pA</span><span class="o">-&gt;</span><span class="n">m_iCellIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">iA</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="execute">
<h2><code class="docutils literal notranslate"><span class="pre">execute</span></code><a class="headerlink" href="#execute" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">execute()</span></code> method is applied to every agent (in parallel).
This method is usually the one most of the action’s work is done.
Here is what we need the virus to do for each agent:
- let the the agent’s virus load grow logistically
- if the agent’s virus load exceeds the lethality level, register it for death
- if the agent’s virus load exceeds the contagion level, it infects all agents in the cell</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">execute</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iAgentIndex</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="n">fT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">omp_get_thread_num</span><span class="p">();</span>

<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="o">*</span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgentIndex</span><span class="p">]);</span>
<span class="w">    </span><span class="c1">// we only handle agents not already marked as dead</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_iLifeState</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// perform the logistic growth of the agent&#39;s viral load</span>
<span class="w">        </span><span class="kt">float</span><span class="w"> </span><span class="n">fM</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_fViralLoad</span><span class="p">;</span>
<span class="w">        </span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_fGrowthRate</span><span class="o">*</span><span class="n">fM</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fM</span><span class="p">);</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iCellIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_iCellIndex</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// check if the agent must die</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_fLethalityLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">registerDeath</span><span class="p">(</span><span class="n">iCellIndex</span><span class="p">,</span><span class="w"> </span><span class="n">iAgentIndex</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// is the agent contagious?</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w">  </span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_fContagionLevel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// loop through agents in cell</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_amCellAgents</span><span class="p">[</span><span class="n">iT</span><span class="p">][</span><span class="n">iCellIndex</span><span class="p">].</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">iOtherAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_amCellAgents</span><span class="p">[</span><span class="n">iCellIndex</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<span class="w">                </span><span class="c1">// we only infect other agents</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iOtherAgent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">iAgentIndex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">T</span><span class="w"> </span><span class="o">*</span><span class="n">pao</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iOtherAgent</span><span class="p">]);</span>
<span class="w">                    </span><span class="c1">// infect!</span>
<span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">dR</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_apWELL</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()]</span><span class="o">-&gt;</span><span class="n">wrandd</span><span class="p">();</span>
<span class="w">                    </span><span class="c1">// we reduce the effective infection probability by multiplying it with (1-immunity)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dR</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_fInfectionProb</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">pao</span><span class="o">-&gt;</span><span class="n">m_fImmunity</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// register infection load for agent</span>
<span class="w">                        </span><span class="n">m_amAgentInfects</span><span class="p">[</span><span class="n">iT</span><span class="p">][</span><span class="n">iOtherAgent</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_fInitialLoad</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="finalize">
<h2><code class="docutils literal notranslate"><span class="pre">finalize</span></code><a class="headerlink" href="#finalize" title="Link to this heading">¶</a></h2>
<p>The method <code class="docutils literal notranslate"><span class="pre">finalize</span></code> is called after all calls to <cite>execute()`</cite>.
Here we finally add to each agent’s virus load the colllected virus load
passed from its neighbors. During <code class="docutils literal notranslate"><span class="pre">execute()</span></code> several maps may have entries
for the same agent.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">finalize</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="n">fT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iT</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_iNumThreads</span><span class="p">;</span><span class="w"> </span><span class="n">iT</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">agentloadmap</span><span class="o">::</span><span class="n">const_iterator</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_amAgentInfects</span><span class="p">[</span><span class="n">iT</span><span class="p">].</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w">  </span><span class="n">m_amAgentInfects</span><span class="p">[</span><span class="n">iT</span><span class="p">].</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">it</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// first:  agent index</span>
<span class="w">            </span><span class="c1">// second: infecttload</span>

<span class="w">            </span><span class="n">T</span><span class="w"> </span><span class="o">*</span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">m_pPop</span><span class="o">-&gt;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">]);</span>
<span class="w">            </span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The remaining methods deal with reading and writing the virus’ attributes.</p>
</section>
<section id="extractattributesqdf">
<h2><code class="docutils literal notranslate"><span class="pre">extractAttributesQDF</span></code><a class="headerlink" href="#extractattributesqdf" title="Link to this heading">¶</a></h2>
<p>This method reads virus attributes from a QDF file.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">extractAttributesQDF</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="n">hSpeciesGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qdf_extractAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_INFECTION_PROB_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fInfectionProb</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;[Virus] couldn&#39;t read attribute [%s]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_INFECTION_PROB_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qdf_extractAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_INITIAL_LOAD_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fInitialLoad</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;[Virus] couldn&#39;t read attribute [%s]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_INITIAL_LOAD_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qdf_extractAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_GROWTH_RATE_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fGrowthRate</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;[Virus] couldn&#39;t read attribute [%s]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_GROWTH_RATE_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qdf_extractAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_CONTAGION_LEVEL_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fContagionLevel</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;[Virus] couldn&#39;t read attribute [%s]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_CONTAGION_LEVEL_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qdf_extractAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_LETHALITY_LEVEL_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fLethalityLevel</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">LOG_ERROR</span><span class="p">(</span><span class="s">&quot;[Virus] couldn&#39;t read attribute [%s]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_LETHALITY_LEVEL_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="writeattributesqdf">
<h2><code class="docutils literal notranslate"><span class="pre">writeAttributesQDF</span></code><a class="headerlink" href="#writeattributesqdf" title="Link to this heading">¶</a></h2>
<p>This method writes the virus’ attributes to a QDF file.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="w"> </span><span class="n">writeAttributesQDF</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="n">hSpeciesGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">qdf_insertAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_INFECTION_PROB_NAME</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fInfectionProb</span><span class="p">);</span>
<span class="w">    </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">qdf_insertAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_INITIAL_LOAD_NAME</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fInitialLoad</span><span class="p">);</span>
<span class="w">    </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">qdf_insertAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_GROWTH_RATE_NAME</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fGrowthRate</span><span class="p">);</span>
<span class="w">    </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">qdf_insertAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_CONTAGION_LEVEL_NAME</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fContagionLevel</span><span class="p">);</span>
<span class="w">    </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">qdf_insertAttribute</span><span class="p">(</span><span class="n">hSpeciesGroup</span><span class="p">,</span><span class="w"> </span><span class="n">ATTR_VIRUS_LETHALITY_LEVEL_NAME</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fLethalityLevel</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="trygetattributes">
<h2><code class="docutils literal notranslate"><span class="pre">tryGetAttributes</span></code><a class="headerlink" href="#trygetattributes" title="Link to this heading">¶</a></h2>
<p>This method reads the virus attributes passed via the <cite>xml population file&lt;pop_xml_ref&gt;</cite>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">tryGetAttributes</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ModuleComplex</span><span class="w"> </span><span class="o">*</span><span class="n">pMC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">stringmap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMC</span><span class="o">-&gt;</span><span class="n">getAttributes</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">checkAttributes</span><span class="p">(</span><span class="n">mParams</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">getAttributeVal</span><span class="p">(</span><span class="n">mParams</span><span class="p">,</span><span class="w">  </span><span class="n">ATTR_VIRUS_INFECTION_PROB_NAME</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_fInfectionProb</span><span class="p">);</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">getAttributeVal</span><span class="p">(</span><span class="n">mParams</span><span class="p">,</span><span class="w">  </span><span class="n">ATTR_VIRUS_INITIAL_LOAD_NAME</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">m_fInitialLoad</span><span class="p">);</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">getAttributeVal</span><span class="p">(</span><span class="n">mParams</span><span class="p">,</span><span class="w">  </span><span class="n">ATTR_VIRUS_GROWTH_RATE_NAME</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">m_fGrowthRate</span><span class="p">);</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">getAttributeVal</span><span class="p">(</span><span class="n">mParams</span><span class="p">,</span><span class="w">  </span><span class="n">ATTR_VIRUS_CONTAGION_LEVEL_NAME</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">m_fContagionLevel</span><span class="p">);</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">getAttributeVal</span><span class="p">(</span><span class="n">mParams</span><span class="p">,</span><span class="w">  </span><span class="n">ATTR_VIRUS_LETHALITY_LEVEL_NAME</span><span class="p">,</span><span class="w">  </span><span class="o">&amp;</span><span class="n">m_fLethalityLevel</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The entire file can be found here: <a class="reference external" href="https://github.com/jodyxha/QHG4/blob/main/QHG4/actions/Virus.cpp">Virus.cpp</a></p>
<section id="implementation-of-the-population-class-virushostpop">
<h3>Implementation of the population class <code class="docutils literal notranslate"><span class="pre">VirusHostPop</span></code><a class="headerlink" href="#implementation-of-the-population-class-virushostpop" title="Link to this heading">¶</a></h3>
<p>Since our <cite>Virus`</cite> action makes certain assumptions about the agents, we can’t use an arbitary population class.
In particular, it needs fields for the virus load and immunity.</p>
<section id="the-header-file">
<h4>The header file<a class="headerlink" href="#the-header-file" title="Link to this heading">¶</a></h4>
<p>First  we have the includes for the header files of all required
actions (among them <code class="docutils literal notranslate"><span class="pre">Virus.h</span></code>), and the header file for the
population’s base class <code class="docutils literal notranslate"><span class="pre">SPopulation</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GetOld.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ATanDeath.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;RandomMove.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Fertility.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Verhulst.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;RandomPair.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Virus.h&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SPopulation.h&quot;</span>
</pre></div>
</div>
<p>Some constants needed to extract mutation rate and inheritance types</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">VAR_VIRUSHOST_MUT_RATE_NAME</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;MutationRate&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">VAR_VIRUSHOST_IMM_INHERIT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;ImmunityInheritance&quot;</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">INH_TYPES</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;mix&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;mat&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;pat&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;min&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;max&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">INH_MIX</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">INH_MAT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">INH_PAT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">INH_MIN</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">INH_MAX</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
<p>Now the declaration of the agent structure: we have members for agent fertility,
and the members for the viral infections virus load, immunity and incoming virus load.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">VirusHostAgent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">m_fAge</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">m_fLastBirth</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">m_iMateIndex</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">m_fViralLoad</span><span class="p">;</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">m_fImmunity</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The declaration of the <code class="docutils literal notranslate"><span class="pre">VirusHostPop</span></code> class derived from <code class="docutils literal notranslate"><span class="pre">SPopulation</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VirusHostPop</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w">  </span><span class="n">SPopulation</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<p>The public methods are the usual: constructor, destructor and methods to
add agent data from a <cite>populatiom dat file&lt;pop_dat_ref&gt;</cite> and to write agent data to a QDF file.
In addition to that there is a method for setting the inital state of the baby
(which we’ve also encountered before), and a method to get a parameter
for the population from the <cite>populaition xml file&lt;pop_xml_ref&gt;</cite> (in this case we need the mutation rate, and the inheritance type).</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">VirusHostPop</span><span class="p">(</span><span class="n">SCellGrid</span><span class="w"> </span><span class="o">*</span><span class="n">pCG</span><span class="p">,</span><span class="w"> </span><span class="n">PopFinder</span><span class="w"> </span><span class="o">*</span><span class="n">pPopFinder</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iLayerSize</span><span class="p">,</span><span class="w"> </span><span class="n">IDGen</span><span class="w"> </span><span class="o">**</span><span class="n">apIDG</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">aulState</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="n">aiSeeds</span><span class="p">);</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">VirusHostPop_SexualPop</span><span class="p">();</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">addPopSpecificAgentData</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iAgentIndex</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">ppData</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">addPopSpecificAgentDataTypeQDF</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="o">*</span><span class="n">hAgentDataType</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">makePopSpecificOffspring</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iAgent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iMother</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iFather</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">getPopParams</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">stringmap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mVarDefs</span><span class="p">);</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">protected</span></code> section there are pointers to the actions of this population
and the variable for the mutation rate.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">protected</span><span class="o">:</span>
<span class="w">    </span><span class="n">GetOld</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="w">      </span><span class="o">*</span><span class="n">m_pGO</span><span class="p">;</span>
<span class="w">    </span><span class="n">ATanDeath</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="w">   </span><span class="o">*</span><span class="n">m_pAD</span><span class="p">;</span>
<span class="w">    </span><span class="n">RandomMove</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="w">  </span><span class="o">*</span><span class="n">m_pRM</span><span class="p">;</span>
<span class="w">    </span><span class="n">Fertility</span><span class="o">&lt;</span><span class="n">VirusHostAgen</span><span class="o">&gt;</span><span class="w">    </span><span class="o">*</span><span class="n">m_pFert</span><span class="p">;</span>
<span class="w">    </span><span class="n">Verhulst</span><span class="o">&lt;</span><span class="n">VirusHostAgen</span><span class="o">&gt;</span><span class="w">     </span><span class="o">*</span><span class="n">m_pVerhulst</span><span class="p">;</span>
<span class="w">    </span><span class="n">RandomPair</span><span class="o">&lt;</span><span class="n">VirusHostAgen</span><span class="o">&gt;</span><span class="w">   </span><span class="o">*</span><span class="n">m_pPair</span><span class="p">;</span>
<span class="w">    </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">VirusHostAgen</span><span class="o">&gt;</span><span class="w">        </span><span class="o">*</span><span class="n">m_pVirus</span><span class="p">;</span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">m_fMutationRate</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id1">
<h2>constructor<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p>Here we instantiate all actions and initialize the fields.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">VirusHostPop</span><span class="o">::</span><span class="n">VirusHostPop</span><span class="p">(</span><span class="n">SCellGrid</span><span class="w"> </span><span class="o">*</span><span class="n">pCG</span><span class="p">,</span><span class="w"> </span><span class="n">PopFinder</span><span class="w"> </span><span class="o">*</span><span class="n">pPopFinder</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iLayerSize</span><span class="p">,</span><span class="w"> </span><span class="n">IDGen</span><span class="w"> </span><span class="o">**</span><span class="n">apIDG</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="o">*</span><span class="n">aulState</span><span class="p">,</span><span class="w"> </span><span class="n">uint</span><span class="w"> </span><span class="o">*</span><span class="n">aiSeeds</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">SPopulation</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pCG</span><span class="p">,</span><span class="w"> </span><span class="n">pPopFinder</span><span class="p">,</span><span class="w"> </span><span class="n">iLayerSize</span><span class="p">,</span><span class="w"> </span><span class="n">apIDG</span><span class="p">,</span><span class="w"> </span><span class="n">aulState</span><span class="p">,</span><span class="w"> </span><span class="n">aiSeeds</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>


<span class="w">    </span><span class="n">m_pGO</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GetOld</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_pAD</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ATanDeath</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_apWELL</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_pRM</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomMove</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_apWELL</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_pFert</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Fertility</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_pVerhulst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Verhulst</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_apWELL</span><span class="p">);</span>

<span class="w">    </span><span class="n">m_pPair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomPair</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_apWELL</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_pVirus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Virus</span><span class="o">&lt;</span><span class="n">VirusHostAgent</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">m_pCG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">m_apWELL</span><span class="p">);</span>

<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pGO</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pAD</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pRM</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pFert</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pVerhulst</span><span class="p">);</span>

<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pPair</span><span class="p">);</span>
<span class="w">    </span><span class="n">m_prio</span><span class="p">.</span><span class="n">addAction</span><span class="p">(</span><span class="n">m_pVirus</span><span class="p">);</span>

<span class="w">    </span><span class="n">m_fMutationRate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">m_sInheritType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mix&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id2">
<h2>destructor<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p>The destructor deletes all action created in the constructor.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">VirusHostPop</span><span class="o">::~</span><span class="n">VirusHostPop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pGO</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pGO</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pAD</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pAD</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pRM</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pRM</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pFert</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pFert</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pVerhulst</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pVerhulst</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pPair</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pPair</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_pVirus</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">delete</span><span class="w"> </span><span class="n">m_pVirus</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="getpopparams">
<h2>getPopParams<a class="headerlink" href="#getpopparams" title="Link to this heading">¶</a></h2>
<p>This method tries to extract mutation rate and inheritance type from the stringmap created by the population XML reader.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>int  VirusHostPop::getPopParams(const stringmap &amp;mVarDefs) {
    int iResult = -1;

    stringmap::const_iterator it = mVarDefs.find(VAR_VIRUSHOST_MUT_RATE_NAME);
    if (it != mVarDefs.end()) {
        float fMutTemp = 0;
        if (strToNum(it-&gt;second, &amp;fMutTemp)) {
            m_fMutationRate = fMutTemp;
            printf(&quot;[VirusHostPop::getPopParams] have mutation rate %f\n&quot;, m_fMutationRate);
            iResult = 0;
        } else {
            // couldn&#39;t convert string to float
        }
    } else {
        // there is no key VAR_VIRUSHOST_MUT_RATE_NAME
    }

    it = mVarDefs.find(VAR_VIRUSHOST_IMM_INHERIT_NAME);
    if (it != mVarDefs.end()) {
        std::string sInheritType = it-&gt;second;

        // handle the &quot;+&quot;
        if (!sInheritType.ends_with(&quot;+&quot;)) {
            m_fMutationRate = 0;
        } else {
            // drop the plus
            sInheritType = sInheritType.substr(0, sInheritType.size()-1);
        }
        // check if valid inherit type
        bool bSearching = true;
        for (int i  = 0; bSearching &amp;&amp; (i &lt; 5); i++) {
            if (sInheritType == INH_TYPES[i]) {
                bSearching = false;
            }
        }

        if (bSearching) {
            printf(&quot;[VirusHostPop::getPopParams] unknown inherit type [%s]\n&quot;, sInheritType.c_str());
        } else {
            m_sInheritType = sInheritType;
            printf(&quot;[VirusHostPop::getPopParams] have inherit type [%s]\n&quot;, m_sInheritType.c_str());
            iResult = 0;
        }

    } else {
        // there is no key VAR_VIRUSHOST_IMM_INHERIT_NAME
    }
    return iResult;
}
</pre></div>
</div>
</section>
<section id="makepopspecificoffspring">
<h2>makePopSpecificOffspring<a class="headerlink" href="#makepopspecificoffspring" title="Link to this heading">¶</a></h2>
<p>This method is called when a baby is born in order to initialize it’s field.
In particular, the baby’s immunity level is determined by the inhertiance type.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">VirusHostPop::makePopSpecificOffspring</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iAgent</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iMother</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">iFather</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_fAge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_fLastBirth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_iMateIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// SPopulation assigns random genders to a baby, ehich is ok here</span>
<span class="w">    </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>


<span class="w">    </span><span class="c1">// register this date as the last birth of the mother</span>
<span class="w">    </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_fLastBirth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_fCurTime</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// the offspring&#39;s immunity is the average of the parents&#39; immunities plus a little fuzz factor.</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_sInheritType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INH_TYPES</span><span class="p">[</span><span class="n">INH_MIX</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iFather</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_sInheritType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INH_TYPES</span><span class="p">[</span><span class="n">INH_MAT</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_sInheritType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INH_TYPES</span><span class="p">[</span><span class="n">INH_PAT</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iFather</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_sInheritType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INH_TYPES</span><span class="p">[</span><span class="n">INH_MIN</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iFather</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">)</span><span class="o">?</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="o">:</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iFather</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_sInheritType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INH_TYPES</span><span class="p">[</span><span class="n">INH_MAX</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iFather</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">)</span><span class="o">?</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="o">:</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iFather</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// shouldn&#39;t happen</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">//mutate</span>
<span class="w">    </span><span class="n">fImm</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">m_apWELL</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()]</span><span class="o">-&gt;</span><span class="n">wgauss</span><span class="p">(</span><span class="n">m_fMutationRate</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fImm</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fImm</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fImm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fImm</span><span class="p">;</span>


<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iMother</span><span class="p">].</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgent</span><span class="p">].</span><span class="n">m_fViralLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Babyinfect: %d -&gt; %d</span><span class="se">\n</span><span class="s">n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">iMother</span><span class="p">,</span><span class="w"> </span><span class="n">iAgent</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>


<span class="w">    </span><span class="c1">//printf(&quot;[VirusHostPop::makePopSpecificOffsprin] baby %d vl %f, imm %f\n&quot;,  iAgent, m_aAgents[iAgent].m_fViralLoad, m_aAgents[iAgent].m_fImmunity);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="addpopspecificagentdata">
<h2>addPopSpecificAgentData<a class="headerlink" href="#addpopspecificagentdata" title="Link to this heading">¶</a></h2>
<p>This method reads agent specific data from the <cite>population dat file&lt;pop_dat_ref&gt;</cite>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">VirusHostPop::addPopSpecificAgentData</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iAgentIndex</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">ppData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addAgentDataSingle</span><span class="p">(</span><span class="n">ppData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgentIndex</span><span class="p">].</span><span class="n">m_fAge</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addAgentDataSingle</span><span class="p">(</span><span class="n">ppData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgentIndex</span><span class="p">].</span><span class="n">m_fLastBirth</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addAgentDataSingle</span><span class="p">(</span><span class="n">ppData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgentIndex</span><span class="p">].</span><span class="n">m_fViralLoad</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iResult</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">iResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addAgentDataSingle</span><span class="p">(</span><span class="n">ppData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m_aAgents</span><span class="p">[</span><span class="n">iAgentIndex</span><span class="p">].</span><span class="n">m_fImmunity</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">iResult</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="addpopspecificagentdatatypeqdf">
<h2>addPopSpecificAgentDataTypeQDF<a class="headerlink" href="#addpopspecificagentdatatypeqdf" title="Link to this heading">¶</a></h2>
<p>This method creates a HDF data type to handlle I/O of agents.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">VirusHostPop::addPopSpecificAgentDataTypeQDF</span><span class="p">(</span><span class="n">hid_t</span><span class="w"> </span><span class="o">*</span><span class="n">hAgentDataType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">VirusHostAgent</span><span class="w"> </span><span class="n">va</span><span class="p">;</span>
<span class="w">    </span><span class="n">H5Tinsert</span><span class="p">(</span><span class="o">*</span><span class="n">hAgentDataType</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Age&quot;</span><span class="p">,</span><span class="w">       </span><span class="n">qoffsetof</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">m_fAge</span><span class="p">),</span><span class="w"> </span><span class="n">H5T_NATIVE_FLOAT</span><span class="p">);</span>
<span class="w">    </span><span class="n">H5Tinsert</span><span class="p">(</span><span class="o">*</span><span class="n">hAgentDataType</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;LastBirth&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qoffsetof</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">m_fLastBirth</span><span class="p">),</span><span class="w"> </span><span class="n">H5T_NATIVE_FLOAT</span><span class="p">);</span>
<span class="w">    </span><span class="n">H5Tinsert</span><span class="p">(</span><span class="o">*</span><span class="n">hAgentDataType</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ViralLoad&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qoffsetof</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">m_fViralLoad</span><span class="p">),</span><span class="w"> </span><span class="n">H5T_NATIVE_FLOAT</span><span class="p">);</span>
<span class="w">    </span><span class="n">H5Tinsert</span><span class="p">(</span><span class="o">*</span><span class="n">hAgentDataType</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Immunity&quot;</span><span class="p">,</span><span class="w">  </span><span class="n">qoffsetof</span><span class="p">(</span><span class="n">va</span><span class="p">,</span><span class="w"> </span><span class="n">m_fImmunity</span><span class="p">),</span><span class="w"> </span><span class="n">H5T_NATIVE_FLOAT</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">The Source File for the Action Class <code class="docutils literal notranslate"><span class="pre">Virus</span></code></a><ul>
<li><a class="reference internal" href="#constructor"><code class="docutils literal notranslate"><span class="pre">constructor</span></code></a></li>
<li><a class="reference internal" href="#destructor"><code class="docutils literal notranslate"><span class="pre">destructor</span></code></a></li>
<li><a class="reference internal" href="#initialize"><code class="docutils literal notranslate"><span class="pre">initialize</span></code></a></li>
<li><a class="reference internal" href="#execute"><code class="docutils literal notranslate"><span class="pre">execute</span></code></a></li>
<li><a class="reference internal" href="#finalize"><code class="docutils literal notranslate"><span class="pre">finalize</span></code></a></li>
<li><a class="reference internal" href="#extractattributesqdf"><code class="docutils literal notranslate"><span class="pre">extractAttributesQDF</span></code></a></li>
<li><a class="reference internal" href="#writeattributesqdf"><code class="docutils literal notranslate"><span class="pre">writeAttributesQDF</span></code></a></li>
<li><a class="reference internal" href="#trygetattributes"><code class="docutils literal notranslate"><span class="pre">tryGetAttributes</span></code></a><ul>
<li><a class="reference internal" href="#implementation-of-the-population-class-virushostpop">Implementation of the population class <code class="docutils literal notranslate"><span class="pre">VirusHostPop</span></code></a><ul>
<li><a class="reference internal" href="#the-header-file">The header file</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id1">constructor</a></li>
<li><a class="reference internal" href="#id2">destructor</a></li>
<li><a class="reference internal" href="#getpopparams">getPopParams</a></li>
<li><a class="reference internal" href="#makepopspecificoffspring">makePopSpecificOffspring</a></li>
<li><a class="reference internal" href="#addpopspecificagentdata">addPopSpecificAgentData</a></li>
<li><a class="reference internal" href="#addpopspecificagentdatatypeqdf">addPopSpecificAgentDataTypeQDF</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="howto_virus_header.html"
                          title="previous chapter">The Header File for the Action Class <code class="docutils literal notranslate"><span class="pre">Virus</span></code></a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="howto_virushost_header.html"
                          title="next chapter">The Header File for the Population Class <code class="docutils literal notranslate"><span class="pre">VirusHostPop</span></code></a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorial/howto_virus_source.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="howto_virushost_header.html" title="The Header File for the Population Class VirusHostPop"
             >next</a> |</li>
        <li class="right" >
          <a href="howto_virus_header.html" title="The Header File for the Action Class Virus"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">QHG4 4.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../tutorial.html" >QHG Tutorial</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="how_to_build_actions_pops.html" >How to Design and Build New Populations and Actions</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">The Source File for the Action Class <code class="docutils literal notranslate"><span class="pre">Virus</span></code></a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, jodyxha.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>